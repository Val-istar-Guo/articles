# 一个人的运维


[Docker]: https://www.docker.com
[Docker Swarm]: https://docs.docker.com/engine/swarm/
[Portainer]: https://www.portainer.io
[Kubernetes]: https://kubernetes.io/

###### 若缺乏得力工具，个人开发者想要维护数个网站就心有余而力不足了。这不仅仅需要花费不少精力开发，更困难的是保持不间断的维护。本文记载了如何使用`Docker`与`Portainer`搭建迷你集群并部署各类服务。

## 价值

- 充分利用各种开源服务，大大降低个人的研发成本
- 快速部署服务
- 省钱
  * 可以尽可能选择性价比高的服务器作为集群的节点。还可以随时更换节点，而不影响部署在其中的服务。
  * 一键暂停暂时不需要的服务。可以减少按照CPU占用来计费的服务节点费用。
- 图形化操作
  * 服务快速扩容
  * 服务启停
  * 服务更新
  * 服务回滚


## 技术选型

- [Docker][Docker]

  [Docker][Docker] 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。
  很多开源服务都在[Docker Hub](https://hub.docker.com/)提供镜像供我们使用。我们也需要将自己开发的服务打包成docker镜像。
- [Docker Swarm][Docker Swarm]

  [Docker Swarm][Docker Swarm] 是 [Docker][Docker] 的集群管理工具。它将 [Docker][Docker] 主机池转变为单个虚拟 [Docker][Docker] 主机。
  [Kubernetes][Kubernetes] 同样是容器编排工具，但是 [Docker Swarm][Docker Swarm] 安装和使用更加简单且对服务器性能要求更低。
  因此也成为搭建个人集群的首选。

- [Portainer][Portainer]

  [Portainer][Portainer] 是集群的可视化管理工具。同时支持[Docker Swarm][Docker Swarm]与[Kubernetes][Kubernetes]的商业软件。
  提供的免费版本完全足够个人运维使用。

## 知识储备

- 熟悉Linux
- 熟悉[Docker][Docker]
- 了解[Docker Swarm]、容器编排、集群等基本概念。

## 设备选购

- 阿里云ECS服务器

  根据个人需要选择型号。我们需要至少一台ECS作为主节点。选择阿里云的ECS主要是因为使用起来感觉比较稳定，不容易出现一些莫名奇妙的问题。追其根本，是因为国内的供应商都在服务器的Linux镜像上动了不少手脚。

  根据需要，我们可以再选购一些工作节点。这里建议可以选择“抢占式实例”。一是便宜；二是可以随时退掉实例再购买新实例，如果大家想购买海外实例部署些什么不可描述的服务，那可是太方便了。尤其是移除实例再添加实例后，服务会自动的部署和启动，省下我们不少功夫。

## 安装Docker

不同Linux的安装方式稍有不同。[Docker][Docker]提供了详细的[安装文档](https://docs.docker.com/engine/install/)。

## 创建Swarm集群管理节点


```shell
docker swarm init --advertise-addr $ADVERTISE_ADDR --data-path-port $DATA_PATH_PORT
```

- `$ADVERTISE_ADDR`

  节点的IP地址，阿里云中这个IP默认是内网IP。如果工作节点处于其他服务商，则需要更换成公网IP

- `$DATA_PATH_PORT`

  覆盖网络流量使用的UDP接口。默认使用4789端口，但是由于在阿里云中：

  > UDP监听的250、4789和4790三个端口为系统保留端口，暂时不对外开放。

  这导致使用阿里云的ECS服务器作为集群节点必须修改此端口，否则添加工作节点后，工作节点上部署的服务会出现异常。
