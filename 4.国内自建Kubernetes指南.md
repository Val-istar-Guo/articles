---
published: true
description: 国内云服务商高昂的Kubernetes售价让人望而却步。而在国内，由于墙的缘故，自建Kubernetes远不像官网描述的那样简单。
tags:
  - 运维
  - Kubernetes
---

# 国内自建公网 Kubernetes 指南

为什么要自己搭建 Kubernetes：

- Kubernetes 可以轻松部署 cert-manager、istio 等开源工具
- Kubernetes 能提供应用的部署、回滚、健康检查、故障转移等功能
- 云厂商价格太过昂贵
- 公网的 Kubernetes 方便根据云厂商的折扣力度，灵活选择购买哪家的机器

自建 Kubernetes 的问题：

- 为了尽可能节省支出，采用单 Master 节点的部署方式。存在 Kubernetes 主节点崩溃的风险
- 公网的 Kubernetes 部署方案可能存在一定安全隐患
- 采购的廉价机器无法运行需要占用大量资源的应用。
  虽然可以单独购买一台好的机器加入集群。但是价格太过昂贵。

## 价格

既然我们自己搭建 Kubernetes 的主要目的是**省钱**，那么看一下我总共花费了多少钱。

首先，我购买了：

- 一台 2 核 4G 40G 云盘 的阿里云 ECS 作为 Master
- 两台 2 核 4G 60G 云盘 的阿里云 ECS 作为 Worker
- 一台 2 核 2G 60G 云盘 的阿里云 ECS 作为 Gateway(istio ingress)

四台 ECS 均购买了三年，选择同配置下最低价格。总共花费约 6691 元（0.2 元/天）。
对比腾讯云是 2.6 元/小时，而阿里云是 2000+元/月

## Linux 系统选择

我分别在`Centos 7`、`Ubuntu 22`、`Debian 11`尝试搭建 Kubernetes。
最终我选择了`Debian 11`，原因如下：

- `Centos 7`内置的软件包太老了，启动 Kubernetes 需要更新许多软件包。
- `Ubuntu 22`比`Debian 11`系统占用了更多的内存，使用丐版服务器的我们必须节俭。

> 后续内容仅包含在`Debian 11`系统安装 Kubernetes 的方案。
> 不包含在`Centos 7`和`Ubuntu 22`系统安装遇到的问题（`Centos 7`尤其多）。

## Kubernetes 架构

Kubernetes 定义了 CRI (Container Runtime Interface 容器运行时接口)。
它使得 Kubernetes 可以使用不同的容器管理软件运行容器。
目前主流的有`containerd`、`docker`以及`cri-o`。

![Kubernetes](./assets/国内自建Kubernetes指南/kubernetes.png "Kubernetes")

> OCI(Open Container Initiative) 是开放容器倡议，定义了容器镜像的格式及运行规范。
> `runc` 是按照 OCI 规范实现的，用于创建和运行容器的 CLI 工具。`runc`直接与`cgroup`/`linux kernel`等进程交互。

从图中我们可以看到我们有三种搭建 Kubernetes 的方案：

1. `Kubelet` -> `cri-o` -> `runc`
2. `Kubelet` -> `cri-containerd` -> `containerd` -> `runc`
3. `Kubelet` -> `docker-shim` -> `docker` -> `containerd` -> `runc`

我最终选择**方案 2**搭建 Kubernetes。
其一是因为我不熟悉`cri-o`；其二是`docker`会占用大量的系统资源，我们的乞丐服务器扛不住。

### 安装`runc`

我们可以进入[github opencontainers/runc](https://github.com/opencontainers/runc)下载并安装`runc`。但是由于国内服务器访问 Github 非常不稳定，我们可以通过以下几个手段解决：

- 通过公共 github 代理（例如<https://ghproxy.com>）或者自建的 github 代理下载。
- 将 runc 文件下载后转存如国内的 OSS/COS 等云存储平台

```shell
# 通过github代理下载
REPO=https://ghproxy.com/github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64
# 通过自己的OSS下载
REPO=https://miaooo-users-service.oss-cn-shanghai.aliyuncs.com/runc.amd64
# 临时存放下载文件的目录
TEMP_FILEPATH=$(mktemp -t runc.amd64.XXXXXX)
# 下载
wget -O ${TEMP_FILEPATH} $REPO
# 安装runc
install -m 755 ${TEMP_FILEPATH} /usr/local/sbin/runc
```

### 安装`containerd`

`containerd`也可以进入[github containerd/containerd](https://github.com/containerd/containerd/tree/main)下载并安装。

```shell
# 通过github代理下载
REPO=https://ghproxy.com/github.com/containerd/containerd/releases/download/v1.6.16/containerd-1.6.16-linux-amd64.tar.gz
# 通过自己的OSS下载
REPO=https://miaooo-users-service.oss-cn-shanghai.aliyuncs.com/containerd-1.6.16-linux-amd64.tar.gz
# 临时存放下载文件的目录
TEMP=$(mktemp -t containerd-1.6.16-linux-amd64.XXXXXX.tar.gz)
# 下载
wget -O ${TEMP} ${REPO}
# 解压/安装
tar xzvf ${TEMP} -C /usr/local
mkdir -p /usr/local/lib/systemd/system
wget -O /usr/local/lib/systemd/system/containerd.service https://ghproxy.com/raw.githubusercontent.com/containerd/containerd/main/containerd.service
systemctl daemon-reload
# 开机启动
systemctl enable --now containerd

# 启用systemd cgroup driver
# https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd-systemd
sed -i \
  -e 's/SystemdCgroup\ =\ false/SystemdCgroup\ =\ true/g' \
  /etc/containerd/config.toml
systemctl restart containerd
```

`containerd`的安装并不像`runc`那么简单。
`kubernetes`每次新建`pod`都会创建[`pause`](https://console.cloud.google.com/gcr/images/google-containers/global/pause-amd64)容器。用于实现`pod`的多个容器间的资源共享/隔离。
不过`pause`镜像的默认地址（registry.k8s.io/pause:3.7）无法在国内访问，因此我们需要修改成国内的镜像源。

```shell
# 阿里云镜像源
export SANDBOX_IMAGE="registry.aliyuncs.com/google_containers/pause:3.7"
# 修改containerd配置
sed -i \
  -e "/sandbox_image/c\    sandbox_image = \"${SANDBOX_IMAGE}\"" \
  /etc/containerd/config.toml
```

`containerd`默认并没有添加 docker 镜像源，我们需要添加相关配置：

```shell
# 添加docker镜像源配置文件
mkdir -p /etc/containerd/certs.d/docker.io
cat >/etc/containerd/certs.d/docker.io/hosts.toml <<EOF
server = "https://docker.io"
[host."https://registry-1.docker.io"]
  capabilities = ["pull", "resolve"]
EOF

# 将docker镜像源配置文件添加到containerd配置中
sed -i \
  -e 's|config_path\ =.*|config_path = \"\/etc\/containerd\/certs.d\"|g' \
  /etc/containerd/config.toml

systemctl daemon-reload
systemctl restart containerd
```

最后我们需要为`containerd`安装`cni`插件：

```shell
# 通过 github 代理下载
REPO=https://ghproxy.com/github.com/containernetworking/plugins/releases/download/v1.2.0/cni-plugins-linux-amd64-v1.2.0.tgz
# 通过自己的OSS下载
REPO=https://miaooo-users-service.oss-cn-shanghai.aliyuncs.com/cni-plugins-linux-amd64-v1.2.0.tgz
# 临时存放下载文件的目录
TEMP=$(mktemp -t cni-plugins-linux-amd64-v1.2.0.XXXXXX.tgz)

# 安装
wget -O ${TEMP} ${REPO}
mkdir -p /opt/cni/bin
tar xzvf ${TEMP} -C /opt/cni/bin
```

> CNI（Container Network Interface）是容器网络接口规范。容器创建时，Kubelet 会通过 CNI 创建网络。容器销毁时也会通过 CNI 销毁网络。
